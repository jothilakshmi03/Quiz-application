<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leaderboard • Online Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand fw-semibold" href="quiz.html">Online Quiz</a>
        <div class="d-flex ms-auto gap-2 align-items-center">
            <span id="welcome" class="text-white-50 small"></span>
            <a class="btn btn-outline-light btn-sm" href="quiz.html">Take Quiz</a>
            <button class="btn btn-light btn-sm" id="logoutBtn">Logout</button>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="mb-0">Leaderboard (Top 5)</h3>
                        <div class="input-group" style="max-width: 260px;">
                            <span class="input-group-text">Filter</span>
                            <select id="categoryFilter" class="form-select">
                                <option value="all" selected>All</option>
                                <!-- If you add categories to results later, wire this up -->
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0" id="board">
                            <thead>
                            <tr>
                                <th style="width:80px">Rank</th>
                                <th>Name</th>
                                <th style="width:120px">Score</th>
                                <th style="width:220px">Date/Time</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div id="emptyState" class="text-center text-muted py-4 d-none">No scores yet. Be the first!</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple session check
    const user = JSON.parse(localStorage.getItem('quiz_user') || 'null');
    const welcome = document.getElementById('welcome');
    if (user) {
      welcome.textContent = `Hi, ${user.name}`;
    } else {
      welcome.textContent = '';
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('quiz_user');
      window.location.href = 'index.html';
    });

    async function fetchUserName(userId) {
      try {
        const res = await fetch(`/user/${userId}`);
        if (!res.ok) return `User#${userId}`;
        const u = await res.json();
        return u && u.name ? u.name : `User#${userId}`;
      } catch (e) {
        return `User#${userId}`;
      }
    }

    async function loadLeaderboard() {
      const tbody = document.querySelector('#board tbody');
      tbody.innerHTML = '';
      const res = await fetch('/leaderboard');
      if (!res.ok) {
        document.getElementById('emptyState').classList.remove('d-none');
        return;
      }
      const data = await res.json();
      if (!data || data.length === 0) {
        document.getElementById('emptyState').classList.remove('d-none');
        return;
      }
      document.getElementById('emptyState').classList.add('d-none');

      // Resolve names in parallel
      const nameMap = {};
      await Promise.all(
        data.map(async (row) => {
          if (!(row.userId in nameMap)) {
            nameMap[row.userId] = await fetchUserName(row.userId);
          }
        })
      );

      data.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="fw-semibold">${idx + 1}</td>
          <td>${nameMap[row.userId] || '—'}</td>
          <td>${row.score}</td>
          <td>${(row.dateTime || '').toString().replace('T', ' ')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadLeaderboard();
</script>
</body>
</html>